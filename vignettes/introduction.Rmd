---
title: "Introduction to riskscorer"
author: "Alexander Meyer"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to riskscorer}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, results='hide', echo=FALSE, cache=TRUE, cache.vars=TRUE}
#library(pander)
#library(printr)
#library(wakefield)
suppressPackageStartupMessages(suppressMessages(suppressWarnings({
  library(dplyr)
  library(ggplot2)
  library(riskscorer)
  library(wakefield)
})))

knitr::opts_chunk$set(dev = "CairoPNG",
                      fig.width = 7,
                      fig.height = 6,
                      echo = FALSE)

```


The package *riskscorer* is an attempt to provide an easy programatical interface to clinical risk models. It supports fuzzy argument matching and is webservice ready via [plumber](http://plumber.trestletech.com/) decoration.
A the moment only operative risk scores in cardiac surgery are implemented:

* [STS Score](http://riskcalc.sts.org/)
* [EuroScore I](http://www.euroscore.org)
* [EuroScore II](http://www.euroscore.org)

The programatical interface can be used in various scenarios:
* Simulation research based on a risk score model (see Figure 1)
* Data pre-processing before analysis.
* Usage of the webservice for rapid batch processing of a data pool

Figure 1 shows a simulated data set. Except crea and sex, all covariates are fixed.

> **Crea: 0.8 - 3.0 mg/dL**
**Sex: Male or Female**
Procedure: CABG+AVR
Weight: 75 kg
Height: 170 cm
Symptoms of heart failure
Age: 75
LVEF: 60 %
  
```{r data-sim-1, cache=TRUE}
# n = 1
# df_sim <- r_data_frame(
#     n = n,
#     id,
#     race(x = c("White", "Hispanic", "Black", "Asian"), prob = c(0.8, 0.1, 0.05, 0.05), name = "Race"),
#     age(x = 50:90),
#     nyha = level,
#     sex,
#     lvef = round(rnorm(n = n, mean = 50, sd = 10), digits = 0),
#     crea = round(rnorm(n = n, mean = 1.1, sd = 0.2), digits = 3),
#     height_cm,
#     group(x = c("Yes", "No"), prob = c(1, 0), name = "CABG"),
#     group(x = c("AVR", "MVReplacement"), prob = c(0.7, 0.3), name = "VALVE")
# )
# df_sim
n = 23
df_sim <- dplyr::data_frame(
  crea = rep(seq(0.8, 3, length.out = n), times = 2),
  gender = rep(c("Male", "Female"), each = n)
)
df_sim$lvef = 60
df_sim$age = 75
df_sim$proc_cabg = TRUE
df_sim$proc_valve = "AVR"
df_sim$chf_2w = TRUE
df_sim$height_cm = 170
df_sim$weight_kg = 75

sims <- df_sim %>% group_by(crea, gender) %>% do(
  calc_sts(proc_valve = .$proc_valve, 
           proc_cabg = .$proc_cabg, 
           age = .$age, 
           gender = .$gender,
           chf_2w = .$chf_2w,
           crea = .$crea,
           height_cm = .$height_cm,
           weight_kg = .$weight_kg,
           lvef = .$lvef)
  #data_frame(proc_valve = .$VALVE, proc_cabg = .$CABG, age = .$Age, gender = .$Sex, crea = .$crea, lvef = .$lvef)
)

sims_long <- tidyr::gather(data = sims, key = Risk, value = probability, Mortality:Short_LOS)

qplot(x = crea, y = probability, facets = ~gender, color = Risk, data = sims_long, geom = c("line")) + theme_bw()

qplot(x = crea, y = probability, facets = ~Risk, color = gender, data = sims_long, geom = c("line")) + theme_bw()
```

Table 1 / Figure 2 - batch processed clusters of a cohort of typical TAVI and CABG patients
```{r data-sim-2, cache=TRUE}

set.seed(5)
n = 4
df_sim_tavi <- r_data_frame(
    n = n,
    age(x = 78:100),
    sex,
    lvef = round(rnorm(n = n, mean = 50, sd = 10), digits = 0),
    crea = round(rnorm(n = n, mean = 1.2, sd = 0.2), digits = 3),
    valid(name = "chf_2w", prob = c(0.1,0.9))
)
df_sim_tavi$Patient = 1:(nrow(df_sim_tavi))
df_sim_tavi$CABG = FALSE
df_sim_tavi$VALVE = "AVR"

df_sim_cabg <- r_data_frame(
    n = n,
    age(x = 40:70),
    sex,
    lvef = round(rnorm(n = n, mean = 50, sd = 10), digits = 0),
    crea = round(rnorm(n = n, mean = 0.8, sd = 0.1), digits = 3),
    valid(name = "chf_2w", prob = c(0.8,0.2))
)
df_sim_cabg$Patient = (nrow(df_sim_tavi)+1):(nrow(df_sim_tavi) + nrow(df_sim_cabg))
df_sim_cabg$CABG = TRUE
df_sim_cabg$VALVE = FALSE

sims <- rbind(df_sim_cabg, df_sim_tavi) %>% group_by(Patient) %>% do(
  calc_sts(proc_valve = .$VALVE, 
           proc_cabg = .$CABG, 
           age = .$Age, 
           gender = .$Sex,
           chf_2w = .$chf_2w,
           crea = .$crea,
           lvef = .$lvef)
  #data_frame(proc_valve = .$VALVE, proc_cabg = .$CABG, age = .$Age, gender = .$Sex, crea = .$crea, lvef = .$lvef)
)

tab_view <- sims %>% 
  dplyr::rename(STS_Risk_Model = Procedure) %>% 
  dplyr::arrange(Patient, Mortality)

knitr::kable(tab_view)

radial_plot(sims %>% dplyr::select(-Short_LOS, -Procedure) %>% dplyr::rename(group = Patient) %>% as.data.frame,
                 grid.min = 0, grid.max = 0.3,legend.title = "Patient",
                 plot.extent.x = 2.0, label.gridline.min = FALSE,
                 label.centre.y = FALSE, centre.y = -0.1,
                 grid.line.width = 0.1
                 )

```

## STS Score Implemtation

**@todo**

* Describe approach of accessing http://riskcalc.sts.org/stswebriskcalc/v1/calculate/stsall 
  via an json interface and fuzzy argument matching and translation for easy usage.
* Works well witg pipes.
* Show a generated figure
* Discuss terms of use of STS web calculator and implications for the programmatical interface
* Present web service posibbility with plumber:
  potential for automatation of risk score calculation for databases/PDMS systems

## ES I and ES II implementation

Terms and conditions disalllow usage or reverse engenierring.

Risk model is simpler and coefficients are published in [XYZ et al., 20XX](http://citation)
- ES I
- ES II 
